#!/usr/bin/ruby
require 'optparse'
require 'churn_cli'

CHURN_OPTS = {format: ['-j', '--json'], compute: ['-a', '--affected-lines', '-i', '--interactive-lines']}
# remove from ARGV our options
argv = ARGV - CHURN_OPTS.values.flatten
# make one string for all other parameters that git will deal with
git_params = argv.reduce{ |a, b| a + " " + b} || ""

churnopts = []
a = i = false

OptionParser.new do |opts|
  opts.banner = "churn [--affected-lines | --interactive-lines] [--json] [any git params]"
  opts.separator "Command line that returns churn related metrics."
  opts.version = InteractiveChurn::VERSION
  opts.on('--json', 'Return metric in json format') { churnopts << '--json' }
  opts.on('--affected-lines', 'Compute affected lines') { a = true; churnopts << '--affected-lines' }
  opts.on('--interactive-lines', 'Compute interactive lines') { i = true; churnopts << '--interactive-lines' }

  begin
    opts.parse!
    raise OptionParser::ParseError.new("--affected-lines and --interactive-lines are mutually exclusive") if a && i
    puts ChurnCLI.print churnopts, git_params
  rescue OptionParser::ParseError => error
    puts error
    puts "(-h or --help will show valid options)"
    exit 1
  rescue Exception => e
    puts e.message
  end
end
